---
import Subpage from "@layouts/Subpage.astro";

import Cookies from "@lib/cookies";
import { db } from "@lib/database";
import { employee } from "@lib/database/schema/employee";
import { group } from "@lib/database/schema/group";

import Remove from "@components/buttons/Remove.astro";
import HTMLInput from "@components/form/HTMLInput.astro";
import HTMLSubmit from "@components/form/HTMLSubmit.astro";

import * as m from "@paraglide/messages";
import { setLanguageTag } from "@paraglide/runtime";

import { eq } from "drizzle-orm";

setLanguageTag((Astro.preferredLocale || "en") as any);

if ((await db.select().from(group)).length == 0) {
  console.log("No groups found in the database! Redirecting to /groups so the user can add one.");
  return Astro.redirect("/groups");
}

let current_group = (Astro.cookies.get(Cookies.current_group) || {})?.value || "";

if (!current_group || current_group === "") {
  Astro.redirect("/");
}

const groups = await db.select().from(group).orderBy(group.name);

let current_group_id = (await db.select({ id: group.id }).from(group).where(eq(group.name, current_group)))[0]["id"];

const employees = await db.select().from(employee).where(eq(employee.group_id, current_group_id)).orderBy(employee.full_name);
---

<Subpage title="Employees">
  <div class="flex flex-col gap-4">
    <h3 class="font-bold text-3xl">{m.add_employee()}:</h3>
    <form method="POST" action="/api/employees" class="flex flex-col gap-8">
      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <HTMLInput name="first_name" placeholder={m.first_name()} type="text" required />
        <HTMLInput name="last_name" placeholder={m.last_name()} type="text" required />

        <select name="group_id" hidden>
          {
            groups.map((group) => {
              const is_current_group = group.name === current_group;

              return (
                <option value={group.id} selected={is_current_group}>
                  {group.name}
                </option>
              );
            })
          }
        </select>
      </div>
      <HTMLSubmit label={m.add()} class="col-span-2" />
    </form>

    {
      employees.length === 0 ? (
        <span class="font-bold text-xl text-center">{m.no_employees()}</span>
      ) : (
        <div class="flex flex-col gap-4">
          <h4 class="font-bold text-xl">{m.all_employees()}:</h4>
          <ul class="grid grid-cols-4 gap-4">
            {employees.map((employee) => {
              return (
                <li class="flex flex-col justify-between gap-4 border-2 rounded-xl px-4 py-2">
                  <span class="font-bold">{employee.full_name}</span>
                  <div>
                    <form method="POST" action="/api/employees/delete">
                      <input name="employee_id" value={employee.id} hidden />

                      <Remove />
                    </form>
                  </div>
                </li>
              );
            })}
          </ul>
        </div>
      )
    }
  </div>
</Subpage>
