---
import Subpage from "@layouts/Subpage.astro";

import { db } from "@lib/database";
import { employee, team } from "@lib/database/schema";

import HTMLInput from "@components/form/HTMLInput.astro";
import HTMLSubmit from "@components/form/HTMLSubmit.astro";

import * as m from "@paraglide/messages";
import { setLanguageTag } from "@paraglide/runtime";

import { eq } from "drizzle-orm";

setLanguageTag((Astro.preferredLocale || "en") as any);

if ((await db.select().from(team)).length == 0) {
  console.log("No teams found in the database! Redirecting to /teams so the user can add one.");
  return Astro.redirect("/teams");
}

let currentTeam = (Astro.cookies.get("current_team") || {})?.value || "";

if (currentTeam === "") {
  Astro.redirect("/");
}

let currentTeamId = (await db.select({ id: team.id }).from(team).where(eq(team.name, currentTeam)))[0].id;

const employees = await db.select().from(employee).where(eq(employee.teamId, currentTeamId)).orderBy(employee.lastName, employee.firstName);
---

<Subpage title="Employees">
  <div class="flex flex-col gap-4">
    <h3 class="font-bold text-3xl">{m.add_employee()}:</h3>
    <form method="POST" action="/api/employees" class="flex flex-col gap-8">
      <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <HTMLInput name="first_name" placeholder={m.first_name()} type="text" required />
        <HTMLInput name="last_name" placeholder={m.last_name()} type="text" required />

        <input type="number" name="team_id" value={currentTeamId} hidden />
      </div>
      <HTMLSubmit label={m.add()} class="col-span-2" />
    </form>

    {
      employees.length === 0 ? (
        <span class="font-bold text-xl text-center">{m.no_employees()}</span>
      ) : (
        <div class="rounded-xl">
          <table class="w-full text-sm text-left rtl:text-right">
            <thead class="text-xs uppercase bg-gray-200">
              <tr>
                <th class="px-6 py-3">{m.first_name()}</th>
                <th class="px-6 py-3">{m.last_name()}</th>
                <th />
              </tr>
            </thead>
            <tbody>
              {employees.map((employee) => {
                return (
                  <tr class="even:bg-gray-100">
                    <td class="px-6 py-4">
                      <form method="POST" action="/api/employees/rename" class="flex flex-row justify-between items-center gap-4">
                        <input type="text" name="first_name" value={employee.firstName} class="bg-transparent w-full" autocomplete="off" />
                        <input name="employee_id" value={employee.id} hidden />
                        <input name="team_id" value={employee.teamId} hidden />
                        <input type="submit" hidden />
                      </form>
                    </td>
                    <td class="px-6 py-4">
                      <form method="POST" action="/api/employees/rename" class="flex flex-row justify-between items-center gap-4">
                        <input type="text" name="last_name" value={employee.lastName} class="bg-transparent w-full" autocomplete="off" />
                        <input name="employee_id" value={employee.id} hidden />
                        <input name="team_id" value={employee.teamId} hidden />
                        <input type="submit" hidden />
                      </form>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex flex-row gap-2 justify-end">
                        <form method="POST" action="/api/employees/delete">
                          <input name="employee_id" value={employee.id} hidden class="hidden" />
                          <input type="submit" value="UsuÅ„" class="bg-red-500 text-white text-sm px-2 py-1 rounded-xl" />
                        </form>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )
    }
  </div>
</Subpage>
