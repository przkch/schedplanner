---
import Layout from "@layouts/Common.astro";

import MonthButton from "@components/buttons/MonthButton.astro";
import MonthPicker from "@components/buttons/MonthPicker.astro";
import Table from "@components/schedule/Table.astro";

import { db } from "@lib/database";
import { team } from "@lib/database/schema";

import * as m from "@paraglide/messages";
import { setLanguageTag } from "@paraglide/runtime";

import { eq } from "drizzle-orm";

setLanguageTag((Astro.preferredLocale || "en") as any);

let currentTeamId: number | undefined;

if (Astro.cookies.has("current_team_id")) {
  currentTeamId = Astro.cookies.get("current_team_id")?.number();
  if (currentTeamId && (await db.select().from(team).where(eq(team.id, currentTeamId))).length == 0) {
    console.warn(`Team id '${currentTeamId}' not found in the database! Clearing the cookie.`);
    Astro.cookies.delete("current_team_id");
    currentTeamId = undefined;
  }
}

if (!currentTeamId) {
  const defaultTeam = (await db.select({ id: team.id }).from(team).where(eq(team.defaultTeam, true)))[0];
  currentTeamId = defaultTeam.id;
  Astro.cookies.set("current_team_id", currentTeamId.toString());
}

if (!currentTeamId) {
  console.log("Current team is for some reason not set, redirecting to /teams");
  return Astro.redirect("/teams");
}

const now = new Date();
const year = Astro.cookies.get("year")?.number() || now.getFullYear();
const month = Astro.cookies.get("month")?.number() || now.getMonth() + 1;
---

<Layout title="SchedPlanner">
  <div class="p-4 mx-auto flex flex-row justify-between gap-4 items-center">
    <MonthButton icon="mdi:arrow-left" text={m.previous()} month={Number(month) - 1} />
    <MonthPicker />
    <MonthButton icon="mdi:arrow-right" text={m.next()} class="flex-row-reverse" month={Number(month) + 1} />
  </div>
  <Table teamId={currentTeamId} year={year} month={month} />
</Layout>
